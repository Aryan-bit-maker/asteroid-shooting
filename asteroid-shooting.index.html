<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Asteroids</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none; /* Prevent browser zooming/scrolling */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlays */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to controls */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #score-board {
            padding: 20px;
            font-size: 24px;
            text-shadow: 0 0 5px #0ff;
            color: #0ff;
            pointer-events: none;
        }

        #start-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border: 2px solid #0ff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            pointer-events: auto;
            z-index: 10;
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 40px;
            color: #0ff;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 10px #0ff;
        }

        button.start-btn {
            background: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 15px 40px;
            font-size: 20px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        button.start-btn:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 15px #fff;
        }

        /* Mobile Controls */
        #mobile-controls {
            display: none; /* Hidden on desktop by default, shown via JS if touch detected */
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 160px;
            pointer-events: none;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
        }

        .left-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            align-items: flex-end;
        }

        .right-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            align-items: flex-end;
        }

        .touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: rgba(0, 255, 255, 0.8);
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            transition: background 0.1s;
        }

        .touch-btn:active, .touch-btn.active {
            background: rgba(0, 255, 255, 0.3);
            border-color: #0ff;
        }

        .btn-fire {
            width: 90px;
            height: 90px;
            border-color: rgba(255, 50, 50, 0.5);
            color: rgba(255, 50, 50, 0.8);
        }
        .btn-fire:active, .btn-fire.active {
            background: rgba(255, 50, 50, 0.3);
            border-color: #f00;
        }

        @media (max-width: 768px) {
            h1 { font-size: 28px; }
            #start-screen { width: 80%; padding: 20px; }
            #mobile-controls { display: block; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        
        <!-- Mobile Controls -->
        <div id="mobile-controls">
            <div class="control-group left-controls">
                <div class="touch-btn" id="btn-left">◀</div>
                <div class="touch-btn" id="btn-thrust">▲</div>
                <div class="touch-btn" id="btn-right">▶</div>
            </div>
            <div class="control-group right-controls">
                <div class="touch-btn btn-fire" id="btn-fire">⦿</div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>Neon Asteroids</h1>
        <p>Use Arrow Keys to Rotate/Thrust</p>
        <p>Spacebar to Shoot</p>
        <p style="font-size: 0.8em; opacity: 0.8;">(On Mobile use on-screen buttons)</p>
        <br>
        <button class="start-btn" onclick="startGame()">Start Mission</button>
    </div>
</div>

<script>
    // --- Configuration ---
    const FPS = 60;
    const FRICTION = 0.7; // 0 = no friction, 1 = lots of friction
    const SHIP_SIZE = 30; // height in pixels
    const TURN_SPEED = 360; // degrees per second
    const THRUST = 5; // acceleration pixels per second per second
    const LASER_MAX = 10; // max number of lasers on screen at once
    const LASER_SPD = 500; // px per sec
    const LASER_DIST = 0.6; // max distance laser can travel as fraction of screen width
    const ASTEROID_NUM = 3; // starting number of asteroids
    const ASTEROID_SIZE = 100; // starting size in pixels
    const ASTEROID_SPD = 50; // max starting speed in pixels per second
    const ASTEROID_VERT = 10; // average number of vertices on each asteroid
    const ASTEROID_JAG = 0.4; // irregularity of asteroid path (0 = none, 1 = lots)

    // --- Setup Canvas ---
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    
    let canvasWidth, canvasHeight;

    function resizeCanvas() {
        canvasWidth = window.innerWidth;
        canvasHeight = window.innerHeight;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- Game State ---
    let level, lives, score, highScore;
    let ship, asteroids, lasers, particles;
    let textAlpha;
    let gameRunning = false;
    let gameOver = false;

    // --- Input Handling ---
    const keys = {
        ArrowUp: false,
        ArrowLeft: false,
        ArrowRight: false,
        Space: false
    };

    // Keyboard
    document.addEventListener("keydown", keyDown);
    document.addEventListener("keyup", keyUp);

    function keyDown(ev) {
        if(ev.code === "ArrowUp" || ev.code === "KeyW") keys.ArrowUp = true;
        if(ev.code === "ArrowLeft" || ev.code === "KeyA") keys.ArrowLeft = true;
        if(ev.code === "ArrowRight" || ev.code === "KeyD") keys.ArrowRight = true;
        if(ev.code === "Space") {
            shootLaser();
            keys.Space = true;
        }
    }

    function keyUp(ev) {
        if(ev.code === "ArrowUp" || ev.code === "KeyW") keys.ArrowUp = false;
        if(ev.code === "ArrowLeft" || ev.code === "KeyA") keys.ArrowLeft = false;
        if(ev.code === "ArrowRight" || ev.code === "KeyD") keys.ArrowRight = false;
        if(ev.code === "Space") keys.Space = false;
    }

    // Touch Controls
    function setupTouchBtn(id, keyMapping) {
        const btn = document.getElementById(id);
        
        const startAction = (e) => {
            e.preventDefault();
            btn.classList.add('active');
            if (keyMapping === 'Space') {
                shootLaser();
            }
            keys[keyMapping] = true;
        };

        const endAction = (e) => {
            e.preventDefault();
            btn.classList.remove('active');
            keys[keyMapping] = false;
        };

        btn.addEventListener('mousedown', startAction);
        btn.addEventListener('mouseup', endAction);
        btn.addEventListener('mouseleave', endAction);
        
        btn.addEventListener('touchstart', startAction, {passive: false});
        btn.addEventListener('touchend', endAction, {passive: false});
    }

    setupTouchBtn('btn-thrust', 'ArrowUp');
    setupTouchBtn('btn-left', 'ArrowLeft');
    setupTouchBtn('btn-right', 'ArrowRight');
    setupTouchBtn('btn-fire', 'Space');


    // --- Game Logic Classes/Factories ---

    function newShip() {
        return {
            x: canvasWidth / 2,
            y: canvasHeight / 2,
            a: 90 / 180 * Math.PI, // convert to radians
            r: SHIP_SIZE / 2,
            blinkNum: Math.ceil(0.1 * FPS),
            blinkTime: Math.ceil(0.1 * FPS),
            canShoot: true,
            dead: false,
            explodeTime: 0,
            lasers: [],
            rot: 0,
            thrusting: false,
            thrust: {
                x: 0,
                y: 0
            }
        }
    }

    function shootLaser() {
        if (!gameRunning || ship.dead) return;

        // create the laser object
        if (ship.canShoot && lasers.length < LASER_MAX) {
            lasers.push({
                x: ship.x + 4/3 * ship.r * Math.cos(ship.a),
                y: ship.y - 4/3 * ship.r * Math.sin(ship.a),
                xv: LASER_SPD * Math.cos(ship.a) / FPS,
                yv: -LASER_SPD * Math.sin(ship.a) / FPS,
                dist: 0,
                explodeTime: 0
            });
        }
        // prevent further shooting immediately
        ship.canShoot = false;
    }

    function createAsteroid(x, y, r) {
        let lvlMult = 1 + 0.1 * level;
        let roid = {
            x: x,
            y: y,
            xv: Math.random() * ASTEROID_SPD * lvlMult / FPS * (Math.random() < 0.5 ? 1 : -1),
            yv: Math.random() * ASTEROID_SPD * lvlMult / FPS * (Math.random() < 0.5 ? 1 : -1),
            r: r,
            a: Math.random() * Math.PI * 2, // angle
            vert: Math.floor(Math.random() * (ASTEROID_VERT + 1) + ASTEROID_VERT / 2),
            offs: []
        };

        // create the vertex offsets array
        for (let i = 0; i < roid.vert; i++) {
            roid.offs.push(Math.random() * ASTEROID_JAG * 2 + 1 - ASTEROID_JAG);
        }

        return roid;
    }

    function createAsteroidBelt() {
        asteroids = [];
        let x, y;
        for (let i = 0; i < ASTEROID_NUM + level; i++) {
            // random asteroid location (not touching spaceship)
            do {
                x = Math.floor(Math.random() * canvasWidth);
                y = Math.floor(Math.random() * canvasHeight);
            } while (distBetweenPoints(ship.x, ship.y, x, y) < ASTEROID_SIZE * 2 + ship.r);
            asteroids.push(createAsteroid(x, y, Math.ceil(ASTEROID_SIZE / 2)));
        }
    }

    function destroyAsteroid(index) {
        let x = asteroids[index].x;
        let y = asteroids[index].y;
        let r = asteroids[index].r;

        // split the asteroid in two if necessary
        if (r > Math.ceil(ASTEROID_SIZE / 8)) { // Minimum size
            asteroids.push(createAsteroid(x, y, r / 2));
            asteroids.push(createAsteroid(x, y, r / 2));
        }
        
        // Spawn explosion particles
        createParticles(x, y, r);

        asteroids.splice(index, 1);
        
        // Scoring
        if(r >= Math.ceil(ASTEROID_SIZE/2)) score += 20;
        else if(r >= Math.ceil(ASTEROID_SIZE/4)) score += 50;
        else score += 100;

        document.getElementById('score-val').innerText = score;

        // Level up
        if (asteroids.length === 0) {
            level++;
            createAsteroidBelt();
        }
    }
    
    function createParticles(x, y, size) {
        const count = 10 + Math.random() * 10;
        for(let i=0; i<count; i++) {
            particles.push({
                x: x, 
                y: y,
                xv: (Math.random() - 0.5) * (Math.random() * 10),
                yv: (Math.random() - 0.5) * (Math.random() * 10),
                life: 1.0, // 100% life
                decay: 0.01 + Math.random() * 0.03,
                color: '#fff' 
            });
        }
    }

    function distBetweenPoints(x1, y1, x2, y2) {
        return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    }

    function explodeShip() {
        ship.explodeTime = Math.ceil(0.3 * FPS);
        createParticles(ship.x, ship.y, 50);
    }
    
    function gameOverSequence() {
        ship.dead = true;
        gameRunning = false;
        document.getElementById('start-screen').style.display = 'block';
        document.querySelector('#start-screen h1').innerText = "GAME OVER";
        document.querySelector('.start-btn').innerText = "Try Again";
    }

    // --- Main Game Loops ---

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        level = 0;
        lives = 3;
        score = 0;
        document.getElementById('score-val').innerText = score;
        ship = newShip();
        lasers = [];
        particles = [];
        createAsteroidBelt();
        gameRunning = true;
        gameOver = false;
        loop();
    }

    function update() {
        if (!gameRunning) return;

        let blinkOn = ship.blinkNum % 2 == 0;
        let exploding = ship.explodeTime > 0;

        // rotate ship
        if (keys.ArrowLeft) ship.a += TURN_SPEED / 180 * Math.PI / FPS;
        if (keys.ArrowRight) ship.a -= TURN_SPEED / 180 * Math.PI / FPS;

        // thrust ship
        if (keys.ArrowUp && !exploding) {
            ship.thrusting = true;
            ship.thrust.x += THRUST * Math.cos(ship.a) / FPS;
            ship.thrust.y -= THRUST * Math.sin(ship.a) / FPS;
            
            // Generate thrust particles occasionally
            if(Math.random() > 0.5) {
                particles.push({
                    x: ship.x - ship.r * Math.cos(ship.a),
                    y: ship.y + ship.r * Math.sin(ship.a),
                    xv: -ship.thrust.x * 0.5 + (Math.random()-0.5),
                    yv: -ship.thrust.y * 0.5 + (Math.random()-0.5),
                    life: 0.5,
                    decay: 0.05,
                    color: '#0ff'
                });
            }
            
        } else {
            ship.thrusting = false;
            ship.thrust.x -= FRICTION * ship.thrust.x / FPS;
            ship.thrust.y -= FRICTION * ship.thrust.y / FPS;
        }

        // move ship
        if (!exploding) {
            ship.x += ship.thrust.x;
            ship.y += ship.thrust.y;

            // handle edge of screen
            if (ship.x < 0 - ship.r) ship.x = canvasWidth + ship.r;
            else if (ship.x > canvasWidth + ship.r) ship.x = 0 - ship.r;
            if (ship.y < 0 - ship.r) ship.y = canvasHeight + ship.r;
            else if (ship.y > canvasHeight + ship.r) ship.y = 0 - ship.r;
        } else {
            ship.explodeTime--;
            if (ship.explodeTime == 0) {
                lives--;
                if (lives == 0) {
                    gameOverSequence();
                } else {
                    ship = newShip();
                }
            }
        }

        // move lasers
        for (let i = lasers.length - 1; i >= 0; i--) {
            // check distance travelled
            lasers[i].dist += Math.sqrt(Math.pow(lasers[i].xv, 2) + Math.pow(lasers[i].yv, 2));

            // handle explosion
            if (lasers[i].explodeTime > 0) {
                lasers[i].explodeTime--;
                if (lasers[i].explodeTime == 0) {
                    lasers.splice(i, 1);
                    continue;
                }
            } else {
                // move laser
                lasers[i].x += lasers[i].xv;
                lasers[i].y += lasers[i].yv;

                // handle edge of screen
                if (lasers[i].x < 0) lasers[i].x = canvasWidth;
                else if (lasers[i].x > canvasWidth) lasers[i].x = 0;
                if (lasers[i].y < 0) lasers[i].y = canvasHeight;
                else if (lasers[i].y > canvasHeight) lasers[i].y = 0;
            }

            // handle too far
            if (lasers[i].dist > canvasWidth * LASER_DIST) {
                lasers.splice(i, 1);
                continue;
            }
        }
        
        // Reset shooting capability if key lifted (logic simplified in key handler, but good safety here)
        if(!keys.Space) ship.canShoot = true;

        // move asteroids
        for (let i = 0; i < asteroids.length; i++) {
            asteroids[i].x += asteroids[i].xv;
            asteroids[i].y += asteroids[i].yv;

            // handle edge of screen
            if (asteroids[i].x < 0 - asteroids[i].r) asteroids[i].x = canvasWidth + asteroids[i].r;
            else if (asteroids[i].x > canvasWidth + asteroids[i].r) asteroids[i].x = 0 - asteroids[i].r;
            if (asteroids[i].y < 0 - asteroids[i].r) asteroids[i].y = canvasHeight + asteroids[i].r;
            else if (asteroids[i].y > canvasHeight + asteroids[i].r) asteroids[i].y = 0 - asteroids[i].r;
        }

        // move particles
        for(let i = particles.length -1; i >= 0; i--) {
            particles[i].x += particles[i].xv;
            particles[i].y += particles[i].yv;
            particles[i].life -= particles[i].decay;
            if(particles[i].life <= 0) particles.splice(i, 1);
        }

        // detect laser hits on asteroids
        let ax, ay, ar, lx, ly;
        for (let i = asteroids.length - 1; i >= 0; i--) {
            ax = asteroids[i].x;
            ay = asteroids[i].y;
            ar = asteroids[i].r;

            // loop over lasers
            for (let j = lasers.length - 1; j >= 0; j--) {
                lx = lasers[j].x;
                ly = lasers[j].y;

                // detect hit
                if (lasers[j].explodeTime == 0 && distBetweenPoints(ax, ay, lx, ly) < ar) {
                    
                    // destroy asteroid
                    destroyAsteroid(i);
                    lasers[j].explodeTime = 1; // trigger laser removal next frame
                    break;
                }
            }
        }

        // detect asteroid hits on ship
        if (!exploding && ship.blinkNum == 0 && !ship.dead) {
            for (let i = 0; i < asteroids.length; i++) {
                if (distBetweenPoints(ship.x, ship.y, asteroids[i].x, asteroids[i].y) < ship.r + asteroids[i].r) {
                    explodeShip();
                    destroyAsteroid(i);
                    break;
                }
            }
        }
    }

    function draw() {
        // draw background
        ctx.fillStyle = "#050505";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);

        // Grid effect (retro vibe)
        ctx.strokeStyle = "rgba(0, 255, 255, 0.05)";
        ctx.lineWidth = 1;
        const gridSize = 50;
        ctx.beginPath();
        for(let x=0; x<canvasWidth; x+=gridSize) { ctx.moveTo(x,0); ctx.lineTo(x,canvasHeight); }
        for(let y=0; y<canvasHeight; y+=gridSize) { ctx.moveTo(0,y); ctx.lineTo(canvasWidth,y); }
        ctx.stroke();

        if (!gameRunning) return;

        let exploding = ship.explodeTime > 0;

        // draw ship
        if (!exploding) {
            // Shadow blur effect
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#0ff";
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            
            ctx.beginP
